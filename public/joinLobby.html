<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/public/styles/global.css">
    <link rel="stylesheet" href="/public/styles/index.css">
    <link rel="stylesheet" href="/public/styles/joinLobby.css" />
    <title>Join Lobby</title>
</head>

<header class="header-wrapper">
    <ul class="nav">
        <li><a href="/" class="about">Home</a></li>
        <li><a href="/login" class="log">Log In</a></li>
        <li><a href="/register" class="register">Register</a></li>
        <li><a href="/dashboard" class="dashboard">Play Now!</a></li>
    </ul>
</header>

<body>
    <div class="join-lobby" id="lobby-wrapper">
        <div class="lobby-head">
            <h1>Join Lobby</h1>
            <div class="search-wrapper"></div>
                <input type="search" class="search" id="search" placeholder="Search for Lobbies...">
                    <button class="search-button" id="searchBtn">Search</button>
            </div>
            <div class="game-data" id="game-data"></div>
        </div>
    </div>

    <dialog class="popup" id="popup">
        <div class="overlay"></div>
        <div class="content">
            <form>
                <fieldset>
                    <label for="password">Enter Lobby Password </label>
                    <input type="text" name="name" id="name"
                        class="text ui-widget-content ui-corner-all">
                    <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
                </fieldset>
            </form>
            <footer>
                <button type="button" id="submit">Submit</button>
                <button type="button" id="cancel">Cancel</button>
            </footer>
        </div>
    </dialog>

    <script>
        (async function(){
            const res = await fetch("/api/loginTest");
            if(!res.ok){
                window.location.href = "/login";
            }
        }());
        
        document.querySelector("#lobby-wrapper").onclick = ()=> popup.close();
        const popup = document.querySelector("#popup");
        popup.onclick = (e)=>e.stopPropagation();

        const searchBar = document.querySelector(".search");
        const searchInput = document.querySelector("#search");
        const searchBtn = document.querySelector("#searchBtn");
        
        

        searchBtn.addEventListener("click",async ()=>{
            if(!searchInput.value){
                await fetchAllGames();
                return;
            }

            await searchGames(searchInput.value);
        })
        
        searchBar.addEventListener("keyup", () => {
            if(searchBar.value && clearIcon.style.visibility != "visible"){
            clearIcon.style.visibility = "visible";
            } else if(!searchBar.value) {
            clearIcon.style.visibility = "hidden";
            }
        });
        
        const createGameNode = (item) =>{

            const game = document.createElement('div');
            game.classList.add("game-node");

            game.style.padding = '5px';
            game.style.border = '2px solid';
            game.style.marginTop = '10px';
            game.style.marginBottom = '10px';
            game.style.marginLeft = '200px';
            game.style.marginRight = '200px';
            game.style.alignContent = 'center';
            game.style.minWidth = '300px';
            game.style.textAlign = 'center';

            const text = document.createElement("p");
            text.innerText = `Lobby Number: ${item.id},  Name: ${item.name}, Password Required: ${item.passwordProtected}, Player Count: ${item.playerCount}`;
            game.appendChild(text);

            const joinLobby = document.createElement('button');
            joinLobby.innerText = "Join Lobby";
            joinLobby.classList.add("join-game")
            game.appendChild(joinLobby);

            joinLobby.addEventListener('click', async (e) => {
                e.stopPropagation();
                //password modal
                if(item.passwordProtected){
                    const popup = document.querySelector("#popup");  
                    popup.show();

                    document.querySelector("#cancel").onclick = function() {
                        popup.close();
                    };
                    document.querySelector("#submit").click(function() {

                    // Add password validation here.
                    
                    });
                }else{
                    const res = await fetch('/api/joinGame', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            gameId: item.id,
                            password: '',
                        }),
                    });
                    if(res.ok){
                        localStorage.setItem('gameId', item.id);
                        window.location.href = `/gameLobby/${item.id}`;
                    }else if(res.status === 400){
                        alert("Error: Game is Full");
                    }else if(res.status === 401){
                        alert("Error: Invalid Credentials");
                    }
                }

            });
            
            return game;
        }


        const fetchAllGames = async () =>{
            const lobbyWrapper = document.querySelector('#game-data');
            const res = await fetch('/api/findGame/all');
            const parsed = await res.json();

            const wrapper = document.createElement("div");
            
            parsed.forEach((item) => {
                const node = createGameNode(item);
                wrapper.appendChild(node);
            });

            lobbyWrapper.innerHTML = "";
            lobbyWrapper.appendChild(wrapper);
        }

        const searchGames = async (name) =>{
            const lobbyWrapper = document.querySelector('#game-data');
            const res = await fetch(`/api/findGame/byName/${name}`);
            const parsed = await res.json();

            const wrapper = document.createElement("div");
            
            parsed.forEach((item) => {
                const node = createGameNode(item);
                wrapper.appendChild(node);
            });

            lobbyWrapper.innerHTML = "";
            lobbyWrapper.appendChild(wrapper);
        }

        fetchAllGames();

        
    </script>
</body>
</html>