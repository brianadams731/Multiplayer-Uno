<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/public/styles/global.css">
    <link rel="stylesheet" href="/public/styles/index.css">
    <link rel="stylesheet" href="/public/styles/joinLobby.css" />
    <title>Join Lobby</title>
</head>

<header class="header-wrapper">
    <ul class="nav">
        <li><a href="/" class="about">Home</a></li>
        <li><a href="/login" class="log">Log In</a></li>
        <li><a href="/register" class="register">Register</a></li>
    </ul>
</header>

<body>
    <div class="join-lobby">
        <div class="lobby-head">
            <h1>Join Lobby</h1>
            <div class="search-wrapper"></div>
                <input type="text" class="search" id="search" placeholder="Search for Lobbies...">
                    <img class="clear-icon" src="data:image/svg+xml;utf8;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/Pgo8IS0tIEdlbmVyYXRvcjogQWRvYmUgSWxsdXN0cmF0b3IgMTkuMC4wLCBTVkcgRXhwb3J0IFBsdWctSW4gLiBTVkcgVmVyc2lvbjogNi4wMCBCdWlsZCAwKSAgLS0+CjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgdmVyc2lvbj0iMS4xIiBpZD0iQ2FwYV8xIiB4PSIwcHgiIHk9IjBweCIgdmlld0JveD0iMCAwIDUxLjk3NiA1MS45NzYiIHN0eWxlPSJlbmFibGUtYmFja2dyb3VuZDpuZXcgMCAwIDUxLjk3NiA1MS45NzY7IiB4bWw6c3BhY2U9InByZXNlcnZlIiB3aWR0aD0iMTZweCIgaGVpZ2h0PSIxNnB4Ij4KPGc+Cgk8cGF0aCBkPSJNNDQuMzczLDcuNjAzYy0xMC4xMzctMTAuMTM3LTI2LjYzMi0xMC4xMzgtMzYuNzcsMGMtMTAuMTM4LDEwLjEzOC0xMC4xMzcsMjYuNjMyLDAsMzYuNzdzMjYuNjMyLDEwLjEzOCwzNi43NywwICAgQzU0LjUxLDM0LjIzNSw1NC41MSwxNy43NCw0NC4zNzMsNy42MDN6IE0zNi4yNDEsMzYuMjQxYy0wLjc4MSwwLjc4MS0yLjA0NywwLjc4MS0yLjgyOCwwbC03LjQyNS03LjQyNWwtNy43NzgsNy43NzggICBjLTAuNzgxLDAuNzgxLTIuMDQ3LDAuNzgxLTIuODI4LDBjLTAuNzgxLTAuNzgxLTAuNzgxLTIuMDQ3LDAtMi44MjhsNy43NzgtNy43NzhsLTcuNDI1LTcuNDI1Yy0wLjc4MS0wLjc4MS0wLjc4MS0yLjA0OCwwLTIuODI4ICAgYzAuNzgxLTAuNzgxLDIuMDQ3LTAuNzgxLDIuODI4LDBsNy40MjUsNy40MjVsNy4wNzEtNy4wNzFjMC43ODEtMC43ODEsMi4wNDctMC43ODEsMi44MjgsMGMwLjc4MSwwLjc4MSwwLjc4MSwyLjA0NywwLDIuODI4ICAgbC03LjA3MSw3LjA3MWw3LjQyNSw3LjQyNUMzNy4wMjIsMzQuMTk0LDM3LjAyMiwzNS40NiwzNi4yNDEsMzYuMjQxeiIgZmlsbD0iIzAwMDAwMCIvPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+Cjwvc3ZnPgo=" />
                    <button class="search-button" id="searchBtn">Search</button>
                    <button id="createGameBtn"  class="create-game">Create Game</button>
            </div>
        </div>
        <div class="game-data" id="game-data"></div>     
    </div>

    <script>  
        const clearIcon = document.querySelector(".clear-icon");
        const searchBar = document.querySelector(".search");
        const searchInput = document.querySelector("#search");
        const searchBtn = document.querySelector("#searchBtn");


         const createGameBtn = document.querySelector("#createGameBtn");
         createGameBtn.addEventListener("click", async(e)=>{
             const res = await fetch("http://localhost:8080/api/createGame",{
                 method:"POST",
                 headers:{
                     "Content-Type":"application/json"
                 },
                 body: JSON.stringify({
                     name:"test game",
                     password: ""
                 })
             })
             if(!res.ok){
                 alert(`ERROR: YOU MUST BE LOGGED IN, CODE: ${res.status}`);
                 return;
             }
             await fetchAllGames();
         });

        searchBtn.addEventListener("click",async ()=>{
            if(!searchInput.value){
                await fetchAllGames();
                return;
            }

            await searchGames(searchInput.value);
        })
        
        searchBar.addEventListener("keyup", () => {
            if(searchBar.value && clearIcon.style.visibility != "visible"){
            clearIcon.style.visibility = "visible";
            } else if(!searchBar.value) {
            clearIcon.style.visibility = "hidden";
            }
        });

        clearIcon.addEventListener("click", () => {
            searchBar.value = "";
            clearIcon.style.visibility = "hidden";
        })   

        
        const createGameNode = (item) =>{
            
            /*{             item interface
                "id": 1,
                "name": "test game",
                "passwordProtected": false,
                "playerCount": "1"
            }*/

            const game = document.createElement('div');
            game.classList.add("game-node");

            game.style.padding = '5px';
            game.style.border = '2px solid';
            game.style.marginTop = '10px';
            game.style.marginBottom = '10px';
            game.style.marginLeft = '200px';
            game.style.marginRight = '200px';
            game.style.alignContent = 'center';
            game.style.minWidth = '300px';
            game.style.textAlign = 'center';

            const text = document.createElement("p");
            text.innerText = `Lobby Number: ${item.id},  Name: ${item.name}, Password Required: ${item.passwordProtected}, Player Count: ${item.playerCount}`;
            game.appendChild(text);

            const joinLobby = document.createElement('button');
            joinLobby.innerText = "Join Lobby";
            joinLobby.classList.add("join-game")
            game.appendChild(joinLobby);

            joinLobby.addEventListener('click', async () => {
            
                if(item.passwordProtected){
                    // open enter password modal here
                }else{
                    const res = await fetch('/api/joinGame', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            gameId: item.id,
                            password: '',
                        }),
                    });
                    localStorage.setItem('gameId', item.id);
                    window.location.href = '/play';
                }

            });
            
            return game;
        }


        const fetchAllGames = async () =>{
            const lobbyWrapper = document.querySelector('#game-data');
            const res = await fetch('/api/findGame/all');
            const parsed = await res.json();

            const wrapper = document.createElement("div");
            
            parsed.forEach((item) => {
                const node = createGameNode(item);
                wrapper.appendChild(node);
            });

            lobbyWrapper.innerHTML = "";
            lobbyWrapper.appendChild(wrapper);
        }

        const searchGames = async (name) =>{
            const lobbyWrapper = document.querySelector('#game-data');
            const res = await fetch(`/api/findGame/byName/${name}`);
            const parsed = await res.json();

            const wrapper = document.createElement("div");
            
            parsed.forEach((item) => {
                const node = createGameNode(item);
                wrapper.appendChild(node);
            });

            lobbyWrapper.innerHTML = "";
            lobbyWrapper.appendChild(wrapper);
        }

        fetchAllGames();

        
    </script>
</body>
</html>