<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/public/styles/global.css">
    <link rel="stylesheet" href="/public/styles/index.css">
    <link rel="stylesheet" href="/public/styles/lobby.css" />
    <title>Join Lobby</title>
</head>
<header class="header-wrapper">
    <ul class="nav">
        <li><a href="/" class="about">Home</a></li>
        <li><a href="/login" class="log">Log In</a></li>
        <li><a href="/register" class="register">Register</a></li>
    </ul>
</header>
<body>

    <div class="lobby-wrapper">
        <div class="lobby-head">
            <h1>Join Lobby</h1>
            <input type="text" class="search" id="search" placeholder="Search for Lobbies"><button class="search-button" id="searchBtn">Search</button>
        </div>
        <div id="game-data"></div>     
    </div>

    <button id="create-game-test">Create Game</button>

    <script>     
        const searchInput = document.querySelector("#search");
        const searchBtn = document.querySelector("#searchBtn");

        const createGameBtn = document.querySelector("#create-game-test");
        createGameBtn.addEventListener("click", async(e)=>{
            const res = await fetch("http://localhost:8080/api/createGame",{
                method:"POST",
                headers:{
                    "Content-Type":"application/json"
                },
                body: JSON.stringify({
                    name:"test game",
                    password: ""
                })
            })
            if(!res.ok){
                alert(`ERROR: YOU MUST BE LOGGED IN, CODE: ${res.status}`);
            }
        });

        searchBtn.addEventListener("click",async ()=>{
            if(!searchInput.value){
                await fetchAllGames();
                return;
            }

            await searchGames(searchInput.value);
        })

        
        const createGameNode = (item) =>{
            
            /*{             item interface
                "id": 1,
                "name": "test game",
                "passwordProtected": false,
                "playerCount": "1"
            }*/

            const game = document.createElement('div');
            game.classList.add("game-node");

            const joinLobby = document.createElement('button');
            joinLobby.innerText = "Join Lobby";
            game.appendChild(joinLobby);

            joinLobby.addEventListener('click', async () => {
            
                if(item.passwordProtected){
                    // open enter password modal here
                }else{
                    const res = await fetch('/api/joinGame', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            gameId: item.id,
                            password: '',
                        }),
                    });
                    localStorage.setItem('gameId', item.id);
                    window.location.href = '/play';
                }

            });

            game.style.padding = '25px';
            game.style.border = '12px solid black';

            const text = document.createElement("p");
            text.innerText = `name: ${item.name}, reqpass: ${item.passwordProtected}, playerCount: ${item.playerCount}`;
            
            game.appendChild(text);

            return game;
        }


        const fetchAllGames = async () =>{
            const lobbyWrapper = document.querySelector('#game-data');
            const res = await fetch('/api/findGame/all');
            const parsed = await res.json();

            const wrapper = document.createElement("div");
            
            parsed.forEach((item) => {
                const node = createGameNode(item);
                wrapper.appendChild(node);
            });

            lobbyWrapper.innerHTML = "";
            lobbyWrapper.appendChild(wrapper);
        }

        const searchGames = async (name) =>{
            const lobbyWrapper = document.querySelector('#game-data');
            const res = await fetch(`/api/findGame/byName/${name}`);
            const parsed = await res.json();

            const wrapper = document.createElement("div");
            
            parsed.forEach((item) => {
                const node = createGameNode(item);
                wrapper.appendChild(node);
            });

            lobbyWrapper.innerHTML = "";
            lobbyWrapper.appendChild(wrapper);
        }

        fetchAllGames();

        
    </script>
</body>
</html>